# Topaz config examples

### 1. Using a public policy image from GHCR based on quickstart guide

If you follow the [topaz quickstart guide](https://github.com/aserto-dev/topaz#quickstart) this is the configuration generated by the `topaz configure -d -s -r ghcr.io/aserto-policies/policy-todo-rebac:latest -n todo` command. 

Example basic configuration using a public GHCR policy image:
```
---
logging:
  prod: true
  log_level: info

directory_service:
  edge:
    db_path: ${TOPAZ_DIR}/db/directory.db
    seed_metadata: true
    
  remote:
    address: "0.0.0.0:9292"
    insecure: true
    
api:
  grpc:
    connection_timeout_seconds: 2
    listen_address: "0.0.0.0:8282"
    certs:
      tls_key_path: "${TOPAZ_DIR}/certs/grpc.key"
      tls_cert_path: "${TOPAZ_DIR}/certs/grpc.crt"
      tls_ca_cert_path: "${TOPAZ_DIR}/certs/grpc-ca.crt"
  gateway:
    listen_address: "0.0.0.0:8383"
    allowed_origins:
    - https://*.aserto.com
    - https://*aserto-console.netlify.app
    certs:
      tls_key_path: "${TOPAZ_DIR}/certs/gateway.key"
      tls_cert_path: "${TOPAZ_DIR}/certs/gateway.crt"
      tls_ca_cert_path: "${TOPAZ_DIR}/certs/gateway-ca.crt"
  health:
    listen_address: "0.0.0.0:8484"

opa:
  instance_id: "-"
  graceful_shutdown_period_seconds: 2
  local_bundles:
    paths: []
    skip_verification: true
  config:
    services:
      ghcr:
        url: https://ghcr.io
        type: "oci"
        response_header_timeout_seconds: 5
    bundles:
      todo:
        service: ghcr
        resource: "ghcr.io/aserto-policies/policy-todo-rebac:latest"
        persist: false
        config:
          polling:
            min_delay_seconds: 60
            max_delay_seconds: 120
```



### 2. Using a private policy image from GHCR

To use a private policy image you need to fill the following configuation with the required information:
1. Github PAT with the available rights to access private packages.
2. Your organization
3. Your policy image name and label

```
---
logging:
  prod: true
  log_level: debug

directory_service:
  edge:
    db_path: ./pkg/testing/assets/eds-citadel.db
    seed_metadata: false
  remote:
    address: "localhost:9292"
    insecure: true

api:
  gateway:
    allowed_origins:
    - https://locahost
  grpc:
    connection_timeout_seconds: 2

opa:
  instance_id: "-"
  graceful_shutdown_period_seconds: 2
  local_bundles:
    paths: []
    skip_verification: true
  config:
    services:
      acmecorp:
        url: https://ghcr.io/
        type: "oci"
        response_header_timeout_seconds: 5
        credentials:
          bearer:
            schema: "Bearer"
            token: "<your_pat>"
    bundles:
      peoplefinder:
        service: acmecorp
        resource: "ghcr.io/<org>/<policy image name>:<policy image tag>"
        persist: false
        config:
          polling:
            min_delay_seconds: 60
            max_delay_seconds: 120
```

### 3. Using topaz with a local policy image

If you follow the [topaz quickstart guide](https://github.com/aserto-dev/topaz#quickstart) and you wish to run an local image that you built with [policy CLI](https://github.com/opcr-io/policy) you can use the `topaz configure -d -s -l ghcr.io/default:latest` to generate this example configuration.

In this case the `ghcr.io/default:latest` policy image is set as your *local_policy_image*. In this example this values is set with the assumption that you [build your policy image](https://openpolicycontainers.com/docs/cli/build) without setting a custom tag.

Using topaz with a local policy image gives you an easier method to ensure that your policies work as you desire before pushing an image to an upstream container registry. 

If you have started topaz with this configuration, if you rebuild the image, any changes will be reflected in your topaz runtime bundle. 

```
---
logging:
  prod: true
  log_level: info

directory_service:
  edge:
    db_path: ${TOPAZ_DIR}/db/directory.db
    seed_metadata: true
    
  remote:
    address: "0.0.0.0:9292"
    insecure: true
    
api:
  grpc:
    connection_timeout_seconds: 2
    listen_address: "0.0.0.0:8282"
    certs:
      tls_key_path: "${TOPAZ_DIR}/certs/grpc.key"
      tls_cert_path: "${TOPAZ_DIR}/certs/grpc.crt"
      tls_ca_cert_path: "${TOPAZ_DIR}/certs/grpc-ca.crt"
  gateway:
    listen_address: "0.0.0.0:8383"
    allowed_origins:
    - https://*.aserto.com
    - https://*aserto-console.netlify.app
    certs:
      tls_key_path: "${TOPAZ_DIR}/certs/gateway.key"
      tls_cert_path: "${TOPAZ_DIR}/certs/gateway.crt"
      tls_ca_cert_path: "${TOPAZ_DIR}/certs/gateway-ca.crt"
  health:
    listen_address: "0.0.0.0:8484"

opa:
  instance_id: "-"
  graceful_shutdown_period_seconds: 2
  local_bundles:
    local_policy_image: ghcr.io/default:latest
    watch: true
    skip_verification: true
```

### 4. Using topaz with remote access to Aserto directory

In this example configuration to allow topaz to interact with the Aserto Directory service you will need to fill in your directory access key and your tenant ID. You can find these values in the Aserto Console: for the directory access key you will find these values in the connections tab for Aserto Directory and to you will find the tenant ID in your account settings. 

In this example, as we use the policy todo image, we recommend setting up a Demo Citadel IDP connection to exercise the example policy paths with the users that have the correct permissions. 


```
---
logging:
  prod: true
  log_level: debug

directory_service:
  remote:
    address: "directory.prod.aserto.com:8443"
    api_key: <your Aserto Directory access key>
    tenant_id: <your Aserto tenant ID>

api:
  gateway:
    allowed_origins:
    - https://locahost
  grpc:
    connection_timeout_seconds: 2

opa:
  instance_id: "-"
  graceful_shutdown_period_seconds: 2
  local_bundles:
    paths: []
    skip_verification: true
  config:
    services:
      acmecorp:
        url: https://ghcr.io/
        type: "oci"
        response_header_timeout_seconds: 5
    bundles:
      peoplefinder:
        service: acmecorp
        resource: "ghcr.io/aserto-policies/policy-todo-rebac:latest"
        persist: false
        config:
          polling:
            min_delay_seconds: 60
            max_delay_seconds: 120
```