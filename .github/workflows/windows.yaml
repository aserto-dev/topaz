name: Windows CI Workflow
on:
  push:

env:
  ref_name: 0.20.16

jobs:
  startup:
    runs-on: ubuntu-latest
    steps:
      - name: Environment variables to output
        id: init
        run: |
          echo "ref_name=${{ env.ref_name }}" >> $GITHUB_OUTPUT

  docker-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 3
      matrix:
        os: [ windows-2019 ]
        include:
          - os: windows-2019
            file: Dockerfile.windows
            base: ltsc2019
            tag: aserto-dev/topaz:${{ needs.init.outputs.ref_name }}-windows-ltsc2019
            latest: aserto-dev/topaz:latest-windows-ltsc2019
    steps:
      - name: Read Configuration
        needs: startup
        uses: hashicorp/vault-action@v2.4.3
        id: vault
        with:
          url: https://vault.eng.aserto.com/
          token: ${{ secrets.VAULT_TOKEN }}
          secrets: |
            kv/data/github  "USERNAME"            | DOCKER_USERNAME;
            kv/data/github  "DOCKER_PUSH_TOKEN"   | DOCKER_PASSWORD;

      - name: Login to GitHub Packages Docker Registry
        uses: docker/login-action@v2
        with:
          registry: https://ghcr.io
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Docker Build
        run: |
          docker build -t ${{ matrix.tag }} -f ${{ matrix.file }} --build-arg BASE=${{ matrix.base }} --build-arg VERSION="${{ env.ref_name }}" --build-arg COMMIT="${{ github.sha }}"
      - name: Docker push
        run: |
          docker tag ${{ matrix.tag }} ${{ matrix.latest }}
          docker push ${{ matrix.tag }} ${{ matrix.latest }}